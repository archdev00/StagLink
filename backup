#!/bin/bash
set -e

# --- CONFIGURATION TOGGLES ---
RUN_MIRROR=true      # Set to true to run mirror backup, false to skip
SHUTDOWN_AFTER=false # Set to true to shut down PC when finished

# --- PATHS ---
SERVER="user@server:/path/to/workdir/"
ARCHIVE="/path/to/archive_backup/"
MIRROR="/path/to/mirror_backup/"
SSH_KEY="path/to/ssh_key"

# 1. Archive new binaries
echo "Archiving new binaries..."
rsync -av --ignore-existing --progress \
  -e "ssh -i $SSH_KEY" \
  --exclude='*.dat' \
  "$SERVER" "$ARCHIVE"

# 2. Update .dat files
echo "Updating .dat files in archive..."
rsync -av --delete --progress \
  -e "ssh -i $SSH_KEY" \
  --include='*/' \
  --include='*.dat' \
  --exclude='*' \
  "$SERVER" "$ARCHIVE"

# 3. Mirror Backup (Toggleable)
if [ "$RUN_MIRROR" = true ]; then
    echo "Creating mirror backup..."
    rsync -av --delete --progress \
      -e "ssh -i $SSH_KEY" \
      "$SERVER" "$MIRROR"
else
    echo "Skipping mirror backup as per toggle."
fi

echo "Backup completed."

# 4. Shutdown (Toggleable)
if [ "$SHUTDOWN_AFTER" = true ]; then
    echo "Shutdown toggle is ON. System will shut down in 60 seconds."
    sudo shutdown -h +1
else
    echo "Shutdown toggle is OFF. Keeping PC awake."
fi
